# å¿«é€ŸéªŒè¯ DecayingCosineAnnealingWarmRestarts

## ğŸš€ åœ¨ Runpod ä¸ŠéªŒè¯

åªéœ€è¦ä¸€ä¸ªå‘½ä»¤ï¼š

```bash
python test_scheduler.py
```

## âœ… æœŸæœ›è¾“å‡º

å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œä½ åº”è¯¥çœ‹åˆ°ï¼š

```
ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”
DecayingCosineAnnealingWarmRestarts éªŒè¯
ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”

======================================================================
æµ‹è¯• 1: åŸºç¡€åŠŸèƒ½éªŒè¯
======================================================================

é…ç½®: lr=1.00e-04, T_0=100, T_mult=2, restart_decay=0.8

æ£€æµ‹åˆ° 3 ä¸ª restart ç‚¹: [100, 300, 700]

Restart å­¦ä¹ ç‡éªŒè¯:
  Restart 1 (step 100): 8.000000e-05 (æœŸæœ›: 8.000000e-05) âœ“
  Restart 2 (step 300): 6.400000e-05 (æœŸæœ›: 6.400000e-05) âœ“
  Restart 3 (step 700): 5.120000e-05 (æœŸæœ›: 5.120000e-05) âœ“

å­¦ä¹ ç‡èŒƒå›´: 2.05e-07 ~ 1.00e-04

======================================================================
æµ‹è¯• 2: PyTorch å…¼å®¹æ€§ (restart_decay=1.0)
======================================================================

æœ€å¤§å·®å¼‚: 0.00e+00
âœ“ PASS - ä¸ PyTorch å®Œå…¨ä¸€è‡´

======================================================================
æµ‹è¯• 3: ä¸åŒ restart_decay å‚æ•°
======================================================================

restart_decay=1.0:
  ç¬¬1æ¬¡ restart: 1.000000e-04
  ç¬¬2æ¬¡ restart: 1.000000e-04
  å®é™…è¡°å‡: 1.0000 (æœŸæœ›: 1.0)
  âœ“ PASS

restart_decay=0.8:
  ç¬¬1æ¬¡ restart: 8.000000e-05
  ç¬¬2æ¬¡ restart: 6.400000e-05
  å®é™…è¡°å‡: 0.8000 (æœŸæœ›: 0.8)
  âœ“ PASS

restart_decay=0.5:
  ç¬¬1æ¬¡ restart: 5.000000e-05
  ç¬¬2æ¬¡ restart: 2.500000e-05
  å®é™…è¡°å‡: 0.5000 (æœŸæœ›: 0.5)
  âœ“ PASS

======================================================================
æµ‹è¯• 4: Cosine æ›²çº¿å½¢çŠ¶
======================================================================

ç¬¬ä¸€ä¸ªå‘¨æœŸ (0-100):
  èµ·å§‹ LR: 1.000000e-04
  ä¸­ç‚¹ LR: 5.000050e-05
  ç»“æŸ LR: 2.000000e-07
  âœ“ PASS - Cosine æ›²çº¿å½¢çŠ¶æ­£ç¡®

======================================================================
æµ‹è¯•æ€»ç»“
======================================================================
  åŸºç¡€åŠŸèƒ½: âœ“ PASS
  PyTorchå…¼å®¹æ€§: âœ“ PASS
  Restartè¡°å‡: âœ“ PASS
  Cosineå½¢çŠ¶: âœ“ PASS

æ€»è®¡: 4/4 æµ‹è¯•é€šè¿‡

ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡! DecayingCosineAnnealingWarmRestarts å·¥ä½œæ­£å¸¸!
```

## âŒ å¦‚æœçœ‹åˆ°é”™è¯¯

é”™è¯¯ç¤ºä¾‹ï¼š
```
TypeError: DummyOpt is not an Optimizer
```

**è§£å†³æ–¹æ¡ˆï¼š** è¿™ä¸ªé”™è¯¯å·²ç»åœ¨æœ€æ–°çš„ `test_scheduler.py` ä¸­ä¿®å¤äº†ã€‚ç¡®ä¿ä½ ä½¿ç”¨çš„æ˜¯æœ€æ–°ç‰ˆæœ¬çš„æµ‹è¯•è„šæœ¬ã€‚

## ğŸ“ å…³é”®æŒ‡æ ‡

ä¸€ä¸ªæ­£å¸¸å·¥ä½œçš„å®ç°åº”è¯¥æ˜¾ç¤ºï¼š

1. **Restart ç‚¹æ­£ç¡®** - åœ¨ 100, 300, 700 ç­‰ä½ç½®
2. **è¡°å‡æ¯”ä¾‹æ­£ç¡®** - æ¯æ¬¡ restart åå­¦ä¹ ç‡ Ã— restart_decay
3. **PyTorch å…¼å®¹** - restart_decay=1.0 æ—¶å·®å¼‚ä¸º 0
4. **Cosine å½¢çŠ¶** - å­¦ä¹ ç‡åœ¨å‘¨æœŸå†…å¹³æ»‘ä¸‹é™

## ğŸ’¡ ä½¿ç”¨æç¤º

### åœ¨è®­ç»ƒä»£ç ä¸­ä½¿ç”¨ï¼š

```python
from toolkit.scheduler import DecayingCosineAnnealingWarmRestarts

# åˆ›å»ºä¼˜åŒ–å™¨
optimizer = torch.optim.AdamW(model.parameters(), lr=1e-4)

# åˆ›å»ºè°ƒåº¦å™¨ - æ¯æ¬¡ restart è¡°å‡åˆ° 80%
scheduler = DecayingCosineAnnealingWarmRestarts(
    optimizer,
    T_0=1000,           # ç¬¬ä¸€ä¸ªå‘¨æœŸ 1000 æ­¥
    T_mult=2,           # æ¯æ¬¡å‘¨æœŸç¿»å€
    eta_min=1e-7,       # æœ€å°å­¦ä¹ ç‡
    restart_decay=0.8   # æ¯æ¬¡ restart è¡°å‡åˆ° 80%
)

# è®­ç»ƒå¾ªç¯
for epoch in range(num_epochs):
    for batch in dataloader:
        loss = train_step(batch)
        optimizer.zero_grad()
        loss.backward()
        optimizer.step()
        scheduler.step()  # â† æ¯ä¸ª batch åè°ƒç”¨
```

### æ¨èå‚æ•°ï¼š

| è®­ç»ƒé•¿åº¦ | T_0 | T_mult | restart_decay |
|---------|-----|--------|---------------|
| çŸ­æœŸ (<5000 æ­¥) | 100-500 | 1 | 0.9 |
| ä¸­æœŸ (5000-20000 æ­¥) | 1000 | 2 | 0.8 |
| é•¿æœŸ (>20000 æ­¥) | 2000 | 2 | 0.7-0.8 |

## ğŸ› æ•…éšœæ’é™¤

å¦‚æœæµ‹è¯•å¤±è´¥ï¼š

1. **Restart ç‚¹ä¸å¯¹** â†’ æ£€æŸ¥ `step()` å‡½æ•°ä¸­çš„å‘¨æœŸè®¡ç®—
2. **è¡°å‡æ¯”ä¾‹é”™è¯¯** â†’ æ£€æŸ¥ `_update_base_lrs()` ä¸­çš„ factor è®¡ç®—
3. **æ›²çº¿ä¸å¹³æ»‘** â†’ æ£€æŸ¥ `get_lr()` ä¸­çš„ cosine å…¬å¼
4. **ä¸ PyTorch ä¸ä¸€è‡´** â†’ ç¡®ä¿ restart_decay=1.0 æ—¶é€»è¾‘ä¸åŸç”Ÿä¸€è‡´

## ğŸ“Š å¯è§†åŒ–ï¼ˆå¯é€‰ï¼‰

å¦‚æœéœ€è¦çœ‹æ›²çº¿å›¾ï¼ˆéœ€è¦ matplotlibï¼‰ï¼š

```bash
pip install matplotlib
python test_scheduler_visual.py
```

è¿™ä¼šç”Ÿæˆ `scheduler_validation.png` æ–‡ä»¶ã€‚
